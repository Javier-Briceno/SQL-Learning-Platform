// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// Define roles for users
enum Role {
  STUDENT
  TUTOR
  ADMIN
}

/// Aufgabentypen für Übungsblätter
enum TaskType {
  TEXT       // Normale Textaufgabe
}

/// Status einer Abgabe
enum SubmissionStatus {
  DRAFT      // Entwurf, noch nicht abgegeben
  SUBMITTED  // Abgegeben
}

/// A registered user (Student, Tutor, Admin)
model User {
  id             Int          @id @default(autoincrement())
  email          String       @unique
  passwordHash   String
  name           String
  role           Role         @default(STUDENT)
  worksheets     Worksheet[]  // Übungsblätter die der Tutor erstellt hat
  submissions    Submission[] // Abgaben die der Student gemacht hat
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @default(now()) @updatedAt
  isBanned       Boolean      @default(false)
  lastActiveAt   DateTime?

  managedDatabases ManagedDatabase[] 
}

/// Übungsblätter
model Worksheet {
  id          Int          @id @default(autoincrement())
  title       String
  description String?
  database    String       // Name der zugeordneten Datenbank
  tutorId     Int          // ID des Tutors, der das Übungsblatt erstellt hat
  tutor       User         @relation(fields: [tutorId], references: [id], onDelete: Cascade)
  tasks       Task[]
  submissions Submission[] // Abgaben von Studenten für dieses Übungsblatt
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @default(now()) @updatedAt

  @@map("worksheets")
}

/// Einzelne Aufgaben innerhalb eines Übungsblatts
model Task {
  id          Int       @id @default(autoincrement())
  worksheetId Int
  worksheet   Worksheet @relation(fields: [worksheetId], references: [id], onDelete: Cascade)
  title       String
  description String
  taskType    TaskType  @default(TEXT)
  orderIndex  Int       // Reihenfolge der Aufgaben
  answers     Answer[]  // Antworten von Studenten auf diese Aufgabe
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now()) @updatedAt

  @@map("tasks")
}

/// Abgaben von Studenten für ein Übungsblatt
model Submission {
  id          Int              @id @default(autoincrement())
  worksheetId Int
  worksheet   Worksheet        @relation(fields: [worksheetId], references: [id], onDelete: Cascade)
  studentId   Int
  student     User             @relation(fields: [studentId], references: [id], onDelete: Cascade)
  status      SubmissionStatus @default(DRAFT)
  answers     Answer[]         // Antworten des Students auf die einzelnen Aufgaben
  submittedAt DateTime?        // Nur gesetzt wenn status = SUBMITTED
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @default(now()) @updatedAt

  // Ein Student kann pro Übungsblatt nur eine Abgabe haben
  @@unique([worksheetId, studentId])
  @@map("submissions")
}

/// Antworten von Studenten auf einzelne Aufgaben
model Answer {
  id           Int        @id @default(autoincrement())
  submissionId Int
  submission   Submission @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  taskId       Int
  task         Task       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  content      String     // Die Antwort des Students
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @default(now()) @updatedAt

  // Eine Antwort pro Aufgabe pro Abgabe
  @@unique([submissionId, taskId])
  @@map("answers")
}

model ManagedDatabase {
  id        Int      @id @default(autoincrement())
  dbName    String   @unique 
  ownerId   Int?      // Besitzer der Datenbank (Tutor)
  owner     User?    @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
}