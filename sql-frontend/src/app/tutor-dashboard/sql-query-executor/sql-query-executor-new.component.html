<mat-card class="sql-executor-container">
  <mat-card-header>
    <mat-card-title>
      <mat-icon>storage</mat-icon>
      SQL Query Executor
    </mat-card-title>
    <mat-card-subtitle>Führe SQL-Abfragen und Datenbankmanipulationen auf verfügbaren Datenbanken aus</mat-card-subtitle>
  </mat-card-header>

  <mat-card-content>
    <!-- Tab System für Read-Only und Manipulation -->
    <mat-tab-group>
      
      <!-- READ-ONLY QUERIES TAB -->
      <mat-tab label="Read-Only Queries" icon="visibility">
        <div class="tab-content">
          <form [formGroup]="queryForm" (ngSubmit)="executeQuery()">
            
            <!-- Datenbank-Auswahl -->
            <div class="form-section">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Datenbank auswählen</mat-label>
                <mat-select formControlName="database" [disabled]="isLoadingDatabases">
                  <mat-option *ngFor="let db of databases" [value]="db">
                    {{ db }}
                  </mat-option>
                </mat-select>
                <mat-hint *ngIf="isLoadingDatabases">Lade Datenbanken...</mat-hint>
                <mat-error *ngIf="databaseControl?.invalid && databaseControl?.touched">
                  Bitte wählen Sie eine Datenbank aus
                </mat-error>
              </mat-form-field>

              <button 
                type="button" 
                mat-icon-button 
                (click)="loadDatabases()" 
                [disabled]="isLoadingDatabases"
                matTooltip="Datenbankliste aktualisieren">
                <mat-icon>refresh</mat-icon>
              </button>
            </div>

            <!-- SQL Query Input -->
            <div class="form-section">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>SQL Query (Read-Only)</mat-label>
                <textarea 
                  matInput 
                  formControlName="query"
                  rows="8"
                  placeholder="Geben Sie hier Ihre SQL-Abfrage ein..."
                  style="max-height: 180px; min-height: 80px; overflow-y: auto; font-family: monospace; white-space: pre; resize: vertical;">
                </textarea>
                <mat-hint>Unterstützte Befehle: SELECT, SHOW, DESCRIBE, EXPLAIN</mat-hint>
                <mat-error *ngIf="queryControl?.invalid && queryControl?.touched">
                  <span *ngIf="queryControl?.errors?.['required']">SQL Query ist erforderlich</span>
                  <span *ngIf="queryControl?.errors?.['minlength']">Query darf nicht leer sein</span>
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
              <button 
                type="submit" 
                mat-raised-button 
                color="primary"
                [disabled]="queryForm.invalid || isExecuting">
                <mat-icon *ngIf="!isExecuting">play_arrow</mat-icon>
                <mat-spinner *ngIf="isExecuting" diameter="20"></mat-spinner>
                {{ isExecuting ? 'Wird ausgeführt...' : 'Query ausführen' }}
              </button>

              <button 
                type="button" 
                mat-button 
                (click)="setExampleQuery()"
                [disabled]="isExecuting">
                <mat-icon>lightbulb</mat-icon>
                Beispiel-Query
              </button>

              <button 
                type="button" 
                mat-button 
                (click)="clearQuery()"
                [disabled]="isExecuting">
                <mat-icon>clear</mat-icon>
                Leeren
              </button>

              <button 
                type="button" 
                mat-button 
                (click)="exportResults()"
                *ngIf="queryResult && queryResult.rows.length > 0"
                [disabled]="isExecuting">
                <mat-icon>download</mat-icon>
                Exportieren
              </button>
            </div>
          </form>

          <!-- Error Display -->
          <div *ngIf="executionError" class="error-container">
            <mat-icon color="warn">error</mat-icon>
            <span>{{ executionError }}</span>
          </div>

          <!-- Results Section -->
          <div *ngIf="queryResult" class="results-section">
            
            <!-- Results Summary -->
            <div class="results-summary">
              <h3>
                <mat-icon>assignment</mat-icon>
                Abfrageergebnisse
              </h3>
              <div class="summary-info">
                <span class="info-item">
                  <strong>Zeilen:</strong> {{ queryResult.rowCount }}
                </span>
                <span class="info-item" *ngIf="queryResult.executionTime">
                  <strong>Ausführungszeit:</strong> {{ queryResult.executionTime }}ms
                </span>
              </div>
            </div>

            <!-- Results Table -->
            <div class="table-container" *ngIf="queryResult.rows.length > 0">
              <div style="overflow-x: auto; max-width: 100%;">
                <table mat-table [dataSource]="queryResult.rows" class="results-table mat-elevation-z2">
                  
                  <!-- Dynamic Columns -->
                  <ng-container 
                    *ngFor="let column of queryResult.columns" 
                    [matColumnDef]="column">
                    <th mat-header-cell *matHeaderCellDef>{{ column }}</th>
                    <td mat-cell *matCellDef="let row">
                      <span class="cell-content">{{ row[column] | json }}</span>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="queryResult.columns"></tr>
                  <tr mat-row *matRowDef="let row; columns: queryResult.columns;"></tr>
                </table>
              </div>
            </div>

            <!-- No Results Message -->
            <div *ngIf="queryResult.rows.length === 0" class="no-results">
              <mat-icon>info</mat-icon>
              <p>Keine Ergebnisse gefunden</p>
            </div>
          </div>
        </div>
      </mat-tab>
      
      <!-- DATABASE MANIPULATION TAB -->
      <mat-tab label="Database Manipulation" icon="edit">
        <div class="tab-content">
          
          <!-- Copy Info Banner -->
          <mat-expansion-panel *ngIf="databaseCopyInfo" class="copy-info-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>content_copy</mat-icon>
                Datenbank-Kopie Information
              </mat-panel-title>
              <mat-panel-description>
                Verbleibende Zeit: {{ getRemainingTime(databaseCopyInfo.expiresAt) }}
              </mat-panel-description>
            </mat-expansion-panel-header>
            <div class="copy-info-content">
              <div class="copy-detail">
                <strong>Original:</strong> {{ databaseCopyInfo.originalDatabase }}
              </div>
              <div class="copy-detail">
                <strong>Kopie:</strong> {{ databaseCopyInfo.copyDatabase }}
              </div>
              <div class="copy-detail">
                <strong>Erstellt:</strong> {{ formatDate(databaseCopyInfo.createdAt) }}
              </div>
              <div class="copy-detail" *ngIf="databaseCopyInfo.lastUsed">
                <strong>Zuletzt verwendet:</strong> {{ formatDate(databaseCopyInfo.lastUsed) }}
              </div>
              <div class="copy-detail">
                <strong>Läuft ab:</strong> {{ formatDate(databaseCopyInfo.expiresAt) }}
              </div>
              <button 
                mat-raised-button 
                color="warn"
                (click)="resetDatabaseCopy(databaseCopyInfo.originalDatabase)"
                class="reset-button">
                <mat-icon>refresh</mat-icon>
                Kopie zurücksetzen
              </button>
            </div>
          </mat-expansion-panel>

          <form [formGroup]="manipulationForm" (ngSubmit)="executeManipulation()">
            
            <!-- Datenbank-Auswahl -->
            <div class="form-section">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Datenbank auswählen</mat-label>
                <mat-select 
                  formControlName="database" 
                  [disabled]="isLoadingDatabases"
                  (selectionChange)="loadDatabaseCopyInfo($event.value)">
                  <mat-option *ngFor="let db of databases" [value]="db">
                    {{ db }}
                  </mat-option>
                </mat-select>
                <mat-hint *ngIf="isLoadingDatabases">Lade Datenbanken...</mat-hint>
                <mat-error *ngIf="manipulationDatabaseControl?.invalid && manipulationDatabaseControl?.touched">
                  Bitte wählen Sie eine Datenbank aus
                </mat-error>
              </mat-form-field>

              <button 
                type="button" 
                mat-icon-button 
                (click)="loadDatabases()" 
                [disabled]="isLoadingDatabases"
                matTooltip="Datenbankliste aktualisieren">
                <mat-icon>refresh</mat-icon>
              </button>
            </div>

            <!-- Reset Database Checkbox -->
            <div class="form-section">
              <mat-checkbox formControlName="resetDatabase">
                Datenbank-Kopie vor Ausführung zurücksetzen
              </mat-checkbox>
            </div>

            <!-- SQL Manipulation Query Input -->
            <div class="form-section">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>SQL Manipulation Query</mat-label>
                <textarea 
                  matInput 
                  formControlName="query"
                  rows="8"
                  placeholder="Geben Sie hier Ihre Manipulation-Query ein..."
                  style="max-height: 180px; min-height: 80px; overflow-y: auto; font-family: monospace; white-space: pre; resize: vertical;">
                </textarea>
                <mat-hint>Unterstützte Befehle: INSERT, UPDATE, DELETE, CREATE TABLE, ALTER TABLE, DROP TABLE</mat-hint>
                <mat-error *ngIf="manipulationQueryControl?.invalid && manipulationQueryControl?.touched">
                  <span *ngIf="manipulationQueryControl?.errors?.['required']">SQL Query ist erforderlich</span>
                  <span *ngIf="manipulationQueryControl?.errors?.['minlength']">Query darf nicht leer sein</span>
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
              <button 
                type="submit" 
                mat-raised-button 
                color="accent"
                [disabled]="manipulationForm.invalid || isExecutingManipulation">
                <mat-icon *ngIf="!isExecutingManipulation">build</mat-icon>
                <mat-spinner *ngIf="isExecutingManipulation" diameter="20"></mat-spinner>
                {{ isExecutingManipulation ? 'Wird ausgeführt...' : 'Manipulation ausführen' }}
              </button>

              <button 
                type="button" 
                mat-button 
                (click)="setExampleManipulationQuery()"
                [disabled]="isExecutingManipulation">
                <mat-icon>lightbulb</mat-icon>
                Beispiel-Query
              </button>

              <button 
                type="button" 
                mat-button 
                (click)="clearManipulationQuery()"
                [disabled]="isExecutingManipulation">
                <mat-icon>clear</mat-icon>
                Leeren
              </button>
            </div>
          </form>

          <!-- Error Display -->
          <div *ngIf="manipulationError" class="error-container">
            <mat-icon color="warn">error</mat-icon>
            <span>{{ manipulationError }}</span>
          </div>

          <!-- Manipulation Results Section -->
          <div *ngIf="manipulationResult" class="results-section">
            
            <!-- Results Summary -->
            <div class="results-summary">
              <h3>
                <mat-icon>check_circle</mat-icon>
                Manipulation Ergebnisse
              </h3>
              <div class="summary-info">
                <mat-chip-set>
                  <mat-chip [class.success-chip]="manipulationResult.success" [class.error-chip]="!manipulationResult.success">
                    {{ manipulationResult.success ? 'Erfolgreich' : 'Fehlgeschlagen' }}
                  </mat-chip>
                  <mat-chip>{{ manipulationResult.queryType }}</mat-chip>
                  <mat-chip>{{ manipulationResult.affectedRows }} betroffene Zeilen</mat-chip>
                  <mat-chip>{{ manipulationResult.executionTime }}ms</mat-chip>
                  <mat-chip *ngIf="manipulationResult.resetPerformed">Kopie zurückgesetzt</mat-chip>
                </mat-chip-set>
              </div>
              <div class="result-message">
                <strong>Nachricht:</strong> {{ manipulationResult.message }}
              </div>
            </div>
          </div>
        </div>
      </mat-tab>
      
      <!-- QUERY HISTORY TAB -->
      <mat-tab label="Historie" icon="history">
        <div class="tab-content">
          <h3>
            <mat-icon>history</mat-icon>
            Query Historie
          </h3>
          
          <div *ngIf="queryHistory.length === 0" class="no-history">
            <mat-icon>info</mat-icon>
            <p>Keine Queries in der Historie</p>
          </div>
          
          <div *ngFor="let item of queryHistory" class="history-item">
            <div class="history-header">
              <mat-chip [class.success-chip]="item.success" [class.error-chip]="!item.success">
                {{ item.success ? 'Erfolgreich' : 'Fehlgeschlagen' }}
              </mat-chip>
              <mat-chip>{{ item.type === 'read' ? 'Read-Only' : 'Manipulation' }}</mat-chip>
              <span class="history-timestamp">{{ item.timestamp | date:'short' }}</span>
            </div>
            <div class="history-content">
              <div class="history-database">
                <strong>Datenbank:</strong> {{ item.database }}
              </div>
              <div class="history-query">
                <pre>{{ item.query }}</pre>
              </div>
              <div class="history-actions">
                <button 
                  mat-button 
                  *ngIf="item.type === 'read'"
                  (click)="loadFromHistory(item)">
                  <mat-icon>replay</mat-icon>
                  In Read-Only laden
                </button>
                <button 
                  mat-button 
                  *ngIf="item.type === 'manipulation'"
                  (click)="loadManipulationFromHistory(item)">
                  <mat-icon>replay</mat-icon>
                  In Manipulation laden
                </button>
              </div>
            </div>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>
  </mat-card-content>
</mat-card>
