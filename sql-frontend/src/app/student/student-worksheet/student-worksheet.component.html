<div class="student-worksheet" *ngIf="!isLoading">
  
  <!-- Header -->
  <div class="worksheet-header">
    <div class="header-content">
      <button mat-icon-button (click)="goBack()" class="back-button">
        <mat-icon>arrow_back</mat-icon>
      </button>
      
      <div class="title-section">        <h1>{{ worksheet?.title }}</h1>
        <p *ngIf="worksheet?.description">{{ worksheet?.description }}</p>
        
        <div class="worksheet-meta">          <mat-chip color="primary" selected>
            <mat-icon matChipAvatar>person</mat-icon>
            {{ worksheet?.tutor?.name }}
          </mat-chip>
          
          <mat-chip color="accent" selected>
            <mat-icon matChipAvatar>storage</mat-icon>
            {{ worksheet?.database }}
          </mat-chip>
          
          <mat-chip 
            [color]="worksheet?.isSubmitted ? 'warn' : 'primary'" 
            selected>
            <mat-icon matChipAvatar>
              {{ worksheet?.isSubmitted ? 'check_circle' : 'edit' }}
            </mat-icon>
            {{ worksheet?.isSubmitted ? 'Abgegeben' : 'In Bearbeitung' }}
          </mat-chip>
        </div>
      </div>
    </div>
    
    <!-- Progress und Status -->
    <div class="progress-section" *ngIf="worksheet && !worksheet?.isSubmitted">
      <div class="progress-info">
        <span class="progress-text">
          Fortschritt: {{ getAnswerProgress().answered }} / {{ getAnswerProgress().total }} Aufgaben
          ({{ getAnswerProgress().percentage }}%)
        </span>
        
        <span *ngIf="lastSaved" class="last-saved">
          Zuletzt gespeichert: {{ formatLastSaved() }}
        </span>
      </div>
      
      <div class="action-buttons">
        <button 
          mat-stroked-button 
          (click)="saveAnswers()" 
          [disabled]="isSaving || !worksheetForm.dirty"
          class="save-button">
          <mat-icon>save</mat-icon>
          <span *ngIf="!isSaving">Speichern</span>
          <span *ngIf="isSaving">Speichere...</span>
        </button>
        
        <button 
          mat-raised-button 
          color="accent"
          (click)="submitWorksheet()" 
          [disabled]="isSubmitting || isSaving"
          class="submit-button">
          <mat-icon>send</mat-icon>
          <span *ngIf="!isSubmitting">Abgeben</span>
          <span *ngIf="isSubmitting">Gebe ab...</span>
        </button>
      </div>
    </div>
  </div>

  <mat-divider></mat-divider>

  <!-- Two-Panel Layout -->
  <div class="two-panel-layout" *ngIf="worksheet">
    
    <!-- Left Panel - Tasks and Answers -->
    <div class="left-panel">
      <div class="panel-header" style="display: flex; align-items: center; gap: 16px;">
  <h2 style="margin: 0; display: flex; align-items: center;">
    <mat-icon>assignment</mat-icon>
    Aufgaben
  </h2>
  <ng-container *ngIf="worksheet && worksheet.tasks && worksheet.tasks.length > 1">
    <mat-form-field appearance="outline" class="task-select-right">
  <mat-label>Aufgabe für KI-Check</mat-label>
  <mat-select [(ngModel)]="selectedTaskIndex" name="selectedTaskIndex">
    <mat-option *ngFor="let task of worksheet.tasks; let i = index" [value]="i">
      Aufgabe {{ i + 1 }}: {{ task.title }}
    </mat-option>
  </mat-select>
</mat-form-field>
  </ng-container>
</div>
      
      <div class="tasks-container">
        <form [formGroup]="worksheetForm">
          <div formArrayName="answers">
            <mat-card 
              *ngFor="let task of worksheet?.tasks; let i = index" 
              class="task-card"
              [class.read-only]="!worksheet.canEdit">
              
              <mat-card-header>
                <div mat-card-avatar>
                  <mat-icon [color]="getTaskColor(task.taskType)">
                    {{ getTaskIcon(task.taskType) }}
                  </mat-icon>
                </div>
                
                <mat-card-title>
                  Aufgabe {{ i + 1 }}: {{ task.title }}
                </mat-card-title>
                
                <mat-card-subtitle>
                  <mat-chip [color]="getTaskColor(task.taskType)" selected size="small">
                    {{ task.taskType === 'TEXT' ? 'Textaufgabe' : 'Aufgabe' }}
                  </mat-chip>
                </mat-card-subtitle>
              </mat-card-header>

              <mat-card-content>
                <div class="task-description">
                  {{ task.description }}
                </div>

                <!-- Answer Input -->
                <div [formGroupName]="i" class="answer-section">
                  <mat-form-field appearance="outline" class="answer-field">
                    <mat-label>Ihre Antwort</mat-label>
                    <textarea 
                      matInput 
                      formControlName="answer"
                      [readonly]="!worksheet.canEdit"
                      rows="4"
                      placeholder="Beschreiben Sie Ihren Lösungsansatz...">
                    </textarea>
                  </mat-form-field>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </form>
      </div>
    </div>

    <!-- Right Panel - Enhanced SQL Executor -->
    <div class="right-panel">
      <div class="panel-header">
        <h2>
          <mat-icon>storage</mat-icon>
          SQL Executor
        </h2>
        <button mat-stroked-button color="primary" (click)="showDatabaseContent()">
          <mat-icon>table_view</mat-icon>
          Datenbank anzeigen
        </button>
      </div>
      
      <mat-card class="sql-executor-card">
        <mat-card-content>
          <!-- Database Operations (Mixed Mode) -->
          <div class="tab-content">
            
            <!-- Copy Info Banner -->
            <mat-expansion-panel *ngIf="databaseCopyInfo" class="copy-info-panel">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  <mat-icon>content_copy</mat-icon>
                  Datenbank-Kopie Information
                </mat-panel-title>
                <mat-panel-description>
                  Verbleibende Zeit: {{ getRemainingTime(databaseCopyInfo.expiresAt) }}
                </mat-panel-description>
              </mat-expansion-panel-header>
              <div class="copy-info-content">
                <div class="copy-detail">
                  <strong>Original:</strong> {{ databaseCopyInfo.originalDatabase }}
                </div>
                <div class="copy-detail">
                  <strong>Kopie:</strong> {{ databaseCopyInfo.copyDatabase }}
                </div>
                <div class="copy-detail">
                  <strong>Erstellt:</strong> {{ formatDate(databaseCopyInfo.createdAt) }}
                </div>
                <div class="copy-detail" *ngIf="databaseCopyInfo.lastUsed">
                  <strong>Zuletzt verwendet:</strong> {{ formatDate(databaseCopyInfo.lastUsed) }}
                </div>
                <div class="copy-detail">
                  <strong>Läuft ab:</strong> {{ formatDate(databaseCopyInfo.expiresAt) }}
                </div>
                <button 
                  mat-raised-button 
                  color="warn"
                  (click)="resetDatabaseCopy()"
                  class="reset-button">
                  <mat-icon>refresh</mat-icon>
                  Kopie zurücksetzen
                </button>
              </div>
            </mat-expansion-panel>

            <form [formGroup]="manipulationForm" (ngSubmit)="executeManipulation()">
              
              <!-- Reset Database Checkbox -->
              <div class="form-section">
                <mat-checkbox formControlName="resetDatabase">
                  Datenbank-Kopie vor Ausführung zurücksetzen
                </mat-checkbox>
              </div>

              <!-- SQL Query Input -->
              <div class="form-section">
                <mat-form-field appearance="outline" class="query-input">
                  <mat-label>SQL Query (Mixed Mode)</mat-label>
                  <textarea 
                    matInput 
                    formControlName="query"
                    rows="8"
                    placeholder="Geben Sie hier Ihre SQL-Query ein (SELECT oder Manipulation)..."
                    style="max-height: 180px; min-height: 80px; overflow-y: auto; font-family: monospace; white-space: pre; resize: vertical;">
                  </textarea>
                  <mat-hint>Unterstützte Befehle: SELECT, INSERT, UPDATE, DELETE, CREATE TABLE, ALTER TABLE, DROP TABLE</mat-hint>
                </mat-form-field>
              </div>

              <!-- Action Buttons -->
              <div class="sql-actions">
                <button 
                  type="submit" 
                  mat-raised-button 
                  color="primary"
                  [disabled]="manipulationForm.invalid || isExecutingManipulation">
                  <mat-icon *ngIf="!isExecutingManipulation">play_arrow</mat-icon>
                  <mat-spinner *ngIf="isExecutingManipulation" diameter="20"></mat-spinner>
                  {{ isExecutingManipulation ? 'Wird ausgeführt...' : 'Query ausführen' }}
                </button>

                <button 
                  type="button" 
                  mat-button 
                  (click)="setExampleManipulationQuery()"
                  [disabled]="isExecutingManipulation">
                  <mat-icon>lightbulb</mat-icon>
                  Beispiel-Query
                </button>

                <button 
                  type="button" 
                  mat-button 
                  (click)="clearManipulationQuery()"
                  [disabled]="isExecutingManipulation">
                  <mat-icon>clear</mat-icon>
                  Leeren
                </button>
              </div>
            </form>

            <!-- Error Display -->
            <div *ngIf="manipulationError" class="error-container">
              <mat-icon color="warn">error</mat-icon>
              <span>{{ manipulationError }}</span>
            </div>

            <!-- Manipulation Results Section -->
            <div *ngIf="manipulationResult" class="results-section">
              
              <!-- Results Summary -->
              <div class="results-summary">
                <h3>
                  <mat-icon>check_circle</mat-icon>
                  Operation Ergebnisse
                </h3>
                <div class="summary-info">
                  <mat-chip-set>
                    <mat-chip [class.success-chip]="manipulationResult.success" [class.error-chip]="!manipulationResult.success">
                      {{ manipulationResult.success ? 'Erfolgreich' : 'Fehlgeschlagen' }}
                    </mat-chip>
                    <mat-chip>{{ manipulationResult.queryType }}</mat-chip>
                    <mat-chip>{{ manipulationResult.affectedRows }} betroffene Zeilen</mat-chip>
                    <mat-chip>{{ manipulationResult.executionTime }}ms</mat-chip>
                    <mat-chip *ngIf="manipulationResult.resetPerformed">Kopie zurückgesetzt</mat-chip>
                  </mat-chip-set>
                </div>
                <div class="result-message">
                  <strong>Nachricht:</strong> {{ manipulationResult.message }}
                </div>
              </div>

              <!-- SELECT Results Data Table (nur für SELECT Queries anzeigen) -->
              <div *ngIf="manipulationResult.queryType === 'SELECT' && manipulationResult.columns && manipulationResult.rows" class="data-table-section">
                <h4>
                  <mat-icon>table_view</mat-icon>
                  Query-Ergebnisse
                </h4>
                
                <div class="table-container">
                  <table mat-table [dataSource]="manipulationResult.rows" class="results-table">
                    
                    <!-- Dynamische Spalten für Query-Ergebnisse -->
                    <ng-container *ngFor="let column of manipulationResult.columns; let i = index" [matColumnDef]="column">
                      <th mat-header-cell *matHeaderCellDef class="table-header">{{ column }}</th>
                      <td mat-cell *matCellDef="let row" class="table-cell">
                        {{ row[column] !== null && row[column] !== undefined ? row[column] : 'NULL' }}
                      </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="manipulationResult.columns"></tr>
                    <tr mat-row *matRowDef="let row; columns: manipulationResult.columns;"></tr>
                  </table>
                </div>

                <!-- No Results Message -->
                <div *ngIf="manipulationResult.rows?.length === 0" class="no-results">
                  <mat-icon>info</mat-icon>
                  <span>Keine Daten gefunden</span>
                </div>
              </div>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
      
      <!-- KI-Check-Button unter dem SQL Executor -->
      <div class="centered-btn">
        <button mat-stroked-button color="accent"
          style="margin-top: 12px;"
          (click)="checkQueryMatchesTaskForMixedMode()"
          [disabled]="isCheckingQuery || manipulationForm.invalid || !worksheet.canEdit">
          <mat-icon>psychology</mat-icon>
          Query von KI prüfen
          <mat-spinner *ngIf="isCheckingQuery" diameter="18" style="margin-left:8px;vertical-align:middle"></mat-spinner>
        </button>
      </div>
      
      <div *ngIf="aiCheckResult">
        <div>
          <strong>KI-Bewertung:</strong>
          <span [ngClass]="{'text-success': aiCheckResult.matches, 'text-danger': !aiCheckResult.matches}">
            {{ aiCheckResult.matches ? 'Korrekt' : 'Nicht korrekt' }}
          </span>
        </div>
        <div class="ai-answer-box" style="margin-top: 8px;">
          <strong>KI-Antwort:</strong>
          <span>{{ getOnlyReason(aiCheckResult.aiAnswer) }}</span>
        </div>
      </div>
    </div>
  </div>
  <!-- Read-Only Message für abgegebene Worksheets -->
  <div *ngIf="worksheet?.isSubmitted" class="submitted-message">
    <mat-card class="info-card">
      <mat-card-content>
        <div class="info-content">
          <mat-icon color="accent">check_circle</mat-icon>
          <div>
            <h3>Übungsblatt abgegeben</h3>
            <p>              Sie haben dieses Übungsblatt am 
              <strong>{{ worksheet?.submission?.submittedAt | date:'dd.MM.yyyy HH:mm' }}</strong> 
              erfolgreich abgegeben.
            </p>
            <p>Ihre Antworten können nicht mehr geändert werden.</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>

<!-- Loading State -->
<div *ngIf="isLoading" class="loading-container">
  <mat-spinner diameter="60"></mat-spinner>
  <p>Lade Übungsblatt...</p>
</div>
